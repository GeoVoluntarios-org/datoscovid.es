---
title:    "Actualización de los datos de Coronavirus"
author:   "by [Santiago Mota](https://www.linkedin.com/in/santiagomota/)"
mail:     "santiago_mota@yahoo.es"
linkedin: "santiagomota"
twitter:  "mota_santiago"
github:   "santiagomota"
date:     "`r Sys.Date()`"
# logo:     "./figs/logo3.png"
license:  by-nc-sa
urlcolor: blue
output:
  html_document: 
    theme:        cosmo # "default", "cerulean", "journal", "flatly", "readable", "spacelab", "united", "cosmo", "lumen", "paper", "sandstone", "simplex", "yeti"
    highlight:    tango # "default", "tango", "pygments", "kate", "monochrome", "espresso", "zenburn", "haddock", "textmate"
    toc:          true
    toc_float:    true
    code_folding: show
    includes:
      after_body: footer.html
  word_document:  default
  pdf_document:   default
  epuRate::epurate:
    toc:             TRUE
    number_sections: FALSE
    code_folding:    "show"
  rmdformats::readthedown:
    toc:          true      
---

```{r}
library(readr)
library(dplyr)
library(TSstudio)
library(xml2)
library(rvest)
library(tmap)
library(stringr)
library(ggplot2)
library(plotly)
```


# Acceso a los datos de Open Data en La Rioja

La base del acceso se hace en [https://actualidad.larioja.org/coronavirus/datos](https://actualidad.larioja.org/coronavirus/datos)


## Evolución

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-452](https://web.larioja.org/dato-abierto/datoabierto?n=opd-452)

La estructura html la sacamos copiando el html en local y abriéndolo con notepad++

```{html}
<div class="col-md-6">
                        <dl>
                            <dt>Fecha de publicación:</dt>
                            <dd>28/04/2020</dd>

                            <dt>Última actualización:</dt>
                            <dd>30/04/2020</dd>

                            <dt>Ámbito temporal</dt>
                            <dd><i class="far fa-calendar-check" aria-hidden="true"></i> 24/02/2020
                                </dd>

                            <dt>Cronología</dt>
                            <dd>Fecha de creación: 28/04/2020 <br>Fecha de actualización de los datos: 30/04/2020</dd>
                        </dl>
                    </div>
```

```{r}
page_evolucion <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-452')

# find all nodes with a class of "col_md_6"
col_md_6_evolucion <- html_nodes(page_evolucion, css = '.col-md-6')
col_md_6_evolucion
```

```{r, eval=FALSE}
html_children(col_md_6_evolucion[8])
```

```{r, eval=FALSE}
class(html_children(col_md_6_evolucion[8]))
```

```{r, eval=FALSE}
# La fecha está en col_md_6_evolucion[8]
html_text(html_children(col_md_6_evolucion[8]))
```

```{r, eval=FALSE}
class(html_text(html_children(col_md_6_evolucion[8])))
```

```{r, eval=FALSE}
json_data <- jsonlite::toJSON(html_text(html_children(col_md_6_evolucion[8])))
json_data
```

```{r, eval=FALSE}
html_children(col_md_6_evolucion[8]) %>%
  str_split("\n")
```

```{r, eval=FALSE}
html_children(col_md_6_evolucion[8]) %>%
  str_split("\n") %>%
  class()
```

```{r, eval=FALSE}
html_children(col_md_6_evolucion[8]) %>%
  str_split("\n") %>%
  unlist()
```

```{r, eval=FALSE}
html_text(html_children(col_md_6_evolucion[8])) %>%
  str_split("\n")
```

Esto si vale

```{r}
fecha_campos_evolucion <- html_children(col_md_6_evolucion[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_evolucion
```

```{r}
fecha_valores_evolucion <- html_children(col_md_6_evolucion[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_evolucion
```

```{r}
link_evolucion <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDUyfGNmPTAz'
```

```{r}
rioja_evolucion <- read_csv(link_evolucion, locale = locale(date_names = "es"),
                            skip = 1, 
                            col_names = c('fecha', 'confirmados_PCR', 'altas', 'fallecidos'))
```

**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_evolucion$fecha <- as.Date(rioja_evolucion$fecha, '%m/%d/%y')
```

Calculamos los acumulados


A la mierda, con un for...


```{r}
# Valores diarios
rioja_evolucion$acumulado_confirmados <- rioja_evolucion$confirmados_PCR[1]
rioja_evolucion$acumulado_altas       <- rioja_evolucion$altas[1]
rioja_evolucion$acumulado_fallecidos  <- rioja_evolucion$fallecidos[1]

for (i in 2:dim(rioja_evolucion)[1]) {
  rioja_evolucion$acumulado_confirmados[i] <- rioja_evolucion$acumulado_confirmados[i-1] + rioja_evolucion$confirmados_PCR[i]
  rioja_evolucion$acumulado_altas[i]       <- rioja_evolucion$acumulado_altas[i-1] +       rioja_evolucion$altas[i]
  rioja_evolucion$acumulado_fallecidos[i]  <- rioja_evolucion$acumulado_fallecidos[i-1] +  rioja_evolucion$fallecidos[i]
}
```

```{r, eval=FALSE}
rioja_evolucion2 <- rioja_evolucion %>%
  arrange(fecha) %>% 
  mutate(total_confirmados = confirmados_PCR + lag(total_confirmados))
```

Incorporamos la fecha del dato

```{r}
rioja_evolucion$fecha_publicacion_evolucion    = as.Date(fecha_valores_evolucion[1], '%d/%m/%Y')
rioja_evolucion$ultima_actualizacion_evolucion = as.Date(fecha_valores_evolucion[2], '%d/%m/%Y')
rioja_evolucion$ambito_temporal_evolucion      = as.Date(fecha_valores_evolucion[3], '%d/%m/%Y')
```

```{r}
summary(rioja_evolucion)
```

Guardamos

```{r}
saveRDS(rioja_evolucion, file = paste0('./data/rioja_evolucion_', Sys.Date(),'.rds'))
```









## Situación de los hospitales de La Rioja

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-461](https://web.larioja.org/dato-abierto/datoabierto?n=opd-461)

```{r}
page_hospitales <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-461')

# find all nodes with a class of "col_md_6"
col_md_6_hospitales <- html_nodes(page_hospitales, css = '.col-md-6')
col_md_6_hospitales
```

```{r}
fecha_campos_hospitales <- html_children(col_md_6_hospitales[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_hospitales
```

```{r}
fecha_valores_hospitales <- html_children(col_md_6_hospitales[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_hospitales
```

Ahora bajamos el fichero

```{r}
link_hospitales <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDYxfGNmPTAz'
```

```{r}
rioja_hospitales <- read_delim(link_hospitales, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_hospitales <- as.data.frame(rioja_hospitales)
```

```{r}
names(rioja_hospitales) <- c("hospital", "hospitalizados_total", 
                             "hospitalizados_planta", "hospitalizados_uci")
```

```{r}
sum(rioja_hospitales$hospitalizados_total, na.rm = TRUE)
```

Creamos una línea con los totales

```{r}
rioja_hospitales <- rbind(rioja_hospitales, data.frame(hospital = 'Total', 
                                                       hospitalizados_total  = sum(rioja_hospitales$hospitalizados_total, na.rm = TRUE), 
                                                       hospitalizados_planta = sum(rioja_hospitales$hospitalizados_planta, na.rm = TRUE), 
                                                       hospitalizados_uci    = sum(rioja_hospitales$hospitalizados_uci, na.rm = TRUE)))
```

Incorporamos la fecha del dato

```{r}
rioja_hospitales$fecha_publicacion_hospitales    = as.Date(fecha_valores_hospitales[1], '%d/%m/%Y')
rioja_hospitales$ultima_actualizacion_hospitales = as.Date(fecha_valores_hospitales[2], '%d/%m/%Y')
rioja_hospitales$ambito_temporal_hospitales      = as.Date(fecha_valores_hospitales[3], '%d/%m/%Y')
```

```{r}
summary(rioja_hospitales)
```

**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(hospitalizados_total               = rioja_hospitales$hospitalizados_total[dim(rioja_hospitales)[1]],
                     hospitalizados_planta              = rioja_hospitales$hospitalizados_planta[dim(rioja_hospitales)[1]],
                     hospitalizados_uci                 = rioja_hospitales$hospitalizados_uci[dim(rioja_hospitales)[1]],
                     
                     hospitalizados_total_s_pedro       = rioja_hospitales$hospitalizados_total[rioja_hospitales$hospital == 'Hospital San Pedro'],
                     hospitalizados_planta_s_pedro      = rioja_hospitales$hospitalizados_planta[rioja_hospitales$hospital == 'Hospital San Pedro'],
                     hospitalizados_uci_s_pedro         = rioja_hospitales$hospitalizados_uci[rioja_hospitales$hospital == 'Hospital San Pedro'],
                     
                     hospitalizados_total_la_rioja      = rioja_hospitales$hospitalizados_total[rioja_hospitales$hospital == 'Hospital de La Rioja'],
                     hospitalizados_planta_la_rioja     = rioja_hospitales$hospitalizados_planta[rioja_hospitales$hospital == 'Hospital de La Rioja'],
                     hospitalizados_uci_la_rioja        = rioja_hospitales$hospitalizados_uci[rioja_hospitales$hospital == 'Hospital de La Rioja'],
                     
                     hospitalizados_total_calahorra     = rioja_hospitales$hospitalizados_total[rioja_hospitales$hospital == 'F. H. Calahorra'],
                     hospitalizados_planta_calahorra    = rioja_hospitales$hospitalizados_planta[rioja_hospitales$hospital == 'F. H. Calahorra'],
                     hospitalizados_uci_calahorra       = rioja_hospitales$hospitalizados_uci[rioja_hospitales$hospital == 'F. H. Calahorra'],
                     
                     hospitalizados_total_manzanos      = rioja_hospitales$hospitalizados_total[rioja_hospitales$hospital == 'Los Manzanos'],
                     hospitalizados_planta_manzanos     = rioja_hospitales$hospitalizados_planta[rioja_hospitales$hospital == 'Los Manzanos'],
                     hospitalizados_uci_manzanos        = rioja_hospitales$hospitalizados_uci[rioja_hospitales$hospital == 'Los Manzanos'],
                     
                     fecha_publicacion_hospitales       = as.Date(fecha_valores_hospitales[1], '%d/%m/%Y'),
                     ultima_actualizacion_hospitales    = as.Date(fecha_valores_hospitales[2], '%d/%m/%Y'),
                     ambito_temporal_hospitales         = as.Date(fecha_valores_hospitales[3], '%d/%m/%Y')
                     )
```

**Sólo pongo los totales. Los datos son semanales**

Guardamos

```{r}
saveRDS(rioja_hospitales, file = paste0('./data/rioja_hospitales_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```



## Porcentaje de hospitalizados por grupo de edad y sexo

Porcentaje de hospitalizados por grupo de edad y sexo a a fecha actual

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-453](https://web.larioja.org/dato-abierto/datoabierto?n=opd-453)

```{r}
page_hospitalizados_porcentaje <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-453')

# find all nodes with a class of "col_md_6"
col_md_6_hospitalizados_porcentaje <- html_nodes(page_hospitalizados_porcentaje, css = '.col-md-6')
col_md_6_hospitalizados_porcentaje
```

```{r}
fecha_campos_hospitalizados_porcentaje <- html_children(col_md_6_hospitalizados_porcentaje[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_hospitalizados_porcentaje
```

```{r}
fecha_valores_hospitalizados_porcentaje <- html_children(col_md_6_hospitalizados_porcentaje[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_hospitalizados_porcentaje
```

Ahora bajamos el fichero

```{r}
link_hospitalizados_porcentaje <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDUzfGNmPTAz'
```

```{r}
rioja_hospitalizados_porcentaje <- read_delim(link_hospitalizados_porcentaje, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_hospitalizados_porcentaje <- as.data.frame(rioja_hospitalizados_porcentaje)
```

```{r}
names(rioja_hospitalizados_porcentaje) <- c("franja_edad", "hombres", 
                             "mujeres", "x4")
```

Borramos x4

```{r}
rioja_hospitalizados_porcentaje <- rioja_hospitalizados_porcentaje[, 1:3]
```

Incorporamos la fecha del dato

```{r}
rioja_hospitalizados_porcentaje$fecha_publicacion_hospitalizados_porcentaje    = as.Date(fecha_valores_hospitalizados_porcentaje[1], '%d/%m/%Y')
rioja_hospitalizados_porcentaje$ultima_actualizacion_hospitalizados_porcentaje = as.Date(fecha_valores_hospitalizados_porcentaje[2], '%d/%m/%Y')
rioja_hospitalizados_porcentaje$ambito_temporal_hospitalizados_porcentaje      = as.Date(fecha_valores_hospitalizados_porcentaje[3], '%d/%m/%Y')
```

```{r}
summary(rioja_hospitalizados_porcentaje)
```

```{r}
str(rioja_hospitalizados_porcentaje)
```

```{r}
sum(rioja_hospitalizados_porcentaje$hombres)
```

```{r}
sum(rioja_hospitalizados_porcentaje$mujeres)
```


**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(
                     # hospitalizados_hombres_00_09       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '0-9 '],
                     # hospitalizados_hombres_10_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '10-19 '],
                     # hospitalizados_hombres_20_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '20-29 '],
                     # hospitalizados_hombres_30_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '30-39 '],
                     # hospitalizados_hombres_40_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '40-49 '],
                     # hospitalizados_hombres_50_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '50-59 '],
                     # hospitalizados_hombres_60_19       = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '60-69 '],
                     # hospitalizados_hombres_70_Mas      = rioja_hospitalizados_porcentaje$hombres[rioja_hospitalizados_porcentaje$franja_edad == '70 y más'],
                     # 
                     # hospitalizados_mujeres_00_09       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '0-9 '],
                     # hospitalizados_mujeres_10_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '10-19 '],
                     # hospitalizados_mujeres_20_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '20-29 '],
                     # hospitalizados_mujeres_30_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '30-39 '],
                     # hospitalizados_mujeres_40_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '40-49 '],
                     # hospitalizados_mujeres_50_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '50-59 '],
                     # hospitalizados_mujeres_60_19       = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '60-69 '],
                     # hospitalizados_mujeres_70_Mas      = rioja_hospitalizados_porcentaje$mujeres[rioja_hospitalizados_porcentaje$franja_edad == '70 y más'],
                     
                     hospitalizados_hombres_00_09       = rioja_hospitalizados_porcentaje$hombres[1],
                     hospitalizados_hombres_10_19       = rioja_hospitalizados_porcentaje$hombres[2],
                     hospitalizados_hombres_20_19       = rioja_hospitalizados_porcentaje$hombres[3],
                     hospitalizados_hombres_30_19       = rioja_hospitalizados_porcentaje$hombres[4],
                     hospitalizados_hombres_40_19       = rioja_hospitalizados_porcentaje$hombres[5],
                     hospitalizados_hombres_50_19       = rioja_hospitalizados_porcentaje$hombres[6],
                     hospitalizados_hombres_60_19       = rioja_hospitalizados_porcentaje$hombres[7],
                     hospitalizados_hombres_70_Mas      = rioja_hospitalizados_porcentaje$hombres[8],
                     
                     hospitalizados_mujeres_00_09       = rioja_hospitalizados_porcentaje$mujeres[1],
                     hospitalizados_mujeres_10_19       = rioja_hospitalizados_porcentaje$mujeres[2],
                     hospitalizados_mujeres_20_19       = rioja_hospitalizados_porcentaje$mujeres[3],
                     hospitalizados_mujeres_30_19       = rioja_hospitalizados_porcentaje$mujeres[4],
                     hospitalizados_mujeres_40_19       = rioja_hospitalizados_porcentaje$mujeres[5],
                     hospitalizados_mujeres_50_19       = rioja_hospitalizados_porcentaje$mujeres[6],
                     hospitalizados_mujeres_60_19       = rioja_hospitalizados_porcentaje$mujeres[7],
                     hospitalizados_mujeres_70_Mas      = rioja_hospitalizados_porcentaje$mujeres[8],
                     
                     
                     fecha_publicacion_hospitalizados_porcentaje       = as.Date(fecha_valores_hospitalizados_porcentaje[1], '%d/%m/%Y'),
                     ultima_actualizacion_hospitalizados_porcentaje    = as.Date(fecha_valores_hospitalizados_porcentaje[2], '%d/%m/%Y'),
                     ambito_temporal_hospitalizados_porcentaje         = as.Date(fecha_valores_hospitalizados_porcentaje[3], '%d/%m/%Y')
                     )
```

Guardamos

```{r}
saveRDS(rioja_hospitalizados_porcentaje, file = paste0('./data/rioja_hospitalizados_porcentaje_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```






## Porcentaje de hospitalizados en UCI por grupo de edad y sexo

Porcentaje de hospitalizados en UCI por grupo de edad y sexo a fecha actual

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-454](https://web.larioja.org/dato-abierto/datoabierto?n=opd-454)

```{r}
page_uci_porcentaje <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-454')

# find all nodes with a class of "col_md_6"
col_md_6_uci_porcentaje <- html_nodes(page_uci_porcentaje, css = '.col-md-6')
col_md_6_uci_porcentaje
```

```{r}
fecha_campos_uci_porcentaje <- html_children(col_md_6_uci_porcentaje[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_uci_porcentaje
```

```{r}
fecha_valores_uci_porcentaje <- html_children(col_md_6_uci_porcentaje[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_uci_porcentaje
```

Ahora bajamos el fichero


```{r}
link_uci_porcentaje <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDU0fGNmPTAz'
```

```{r}
rioja_uci_porcentaje <- read_delim(link_uci_porcentaje, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_uci_porcentaje <- as.data.frame(rioja_uci_porcentaje)
```

```{r}
names(rioja_uci_porcentaje) <- c("franja_edad", "hombres", 
                             "mujeres", "x4")
```

Borramos x4

```{r}
rioja_uci_porcentaje <- rioja_uci_porcentaje[, 1:3]
```

Incorporamos la fecha del dato

```{r}
rioja_uci_porcentaje$fecha_publicacion_uci_porcentaje    = as.Date(fecha_valores_uci_porcentaje[1], '%d/%m/%Y')
rioja_uci_porcentaje$ultima_actualizacion_uci_porcentaje = as.Date(fecha_valores_uci_porcentaje[2], '%d/%m/%Y')
rioja_uci_porcentaje$ambito_temporal_uci_porcentaje      = as.Date(fecha_valores_uci_porcentaje[3], '%d/%m/%Y')
```

```{r}
summary(rioja_uci_porcentaje)
```

```{r}
str(rioja_uci_porcentaje)
```

```{r}
sum(rioja_uci_porcentaje$hombres)
```

```{r}
sum(rioja_uci_porcentaje$mujeres)
```


**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(
                     # uci_hombres_00_09       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '0-9 '],
                     # uci_hombres_10_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '10-19 '],
                     # uci_hombres_20_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '20-29 '],
                     # uci_hombres_30_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '30-39 '],
                     # uci_hombres_40_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '40-49 '],
                     # uci_hombres_50_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '50-59 '],
                     # uci_hombres_60_19       = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '60-69 '],
                     # uci_hombres_70_Mas      = rioja_uci_porcentaje$hombres[rioja_uci_porcentaje$franja_edad == '70 y más'],
                     # 
                     # uci_mujeres_00_09       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '0-9 '],
                     # uci_mujeres_10_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '10-19 '],
                     # uci_mujeres_20_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '20-29 '],
                     # uci_mujeres_30_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '30-39 '],
                     # uci_mujeres_40_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '40-49 '],
                     # uci_mujeres_50_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '50-59 '],
                     # uci_mujeres_60_19       = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '60-69 '],
                     # uci_mujeres_70_Mas      = rioja_uci_porcentaje$mujeres[rioja_uci_porcentaje$franja_edad == '70 y más'],
                     
                     uci_hombres_00_09       = rioja_uci_porcentaje$hombres[1],
                     uci_hombres_10_19       = rioja_uci_porcentaje$hombres[2],
                     uci_hombres_20_19       = rioja_uci_porcentaje$hombres[3],
                     uci_hombres_30_19       = rioja_uci_porcentaje$hombres[4],
                     uci_hombres_40_19       = rioja_uci_porcentaje$hombres[5],
                     uci_hombres_50_19       = rioja_uci_porcentaje$hombres[6],
                     uci_hombres_60_19       = rioja_uci_porcentaje$hombres[7],
                     uci_hombres_70_Mas      = rioja_uci_porcentaje$hombres[8],
                     
                     uci_mujeres_00_09       = rioja_uci_porcentaje$mujeres[1],
                     uci_mujeres_10_19       = rioja_uci_porcentaje$mujeres[2],
                     uci_mujeres_20_19       = rioja_uci_porcentaje$mujeres[3],
                     uci_mujeres_30_19       = rioja_uci_porcentaje$mujeres[4],
                     uci_mujeres_40_19       = rioja_uci_porcentaje$mujeres[5],
                     uci_mujeres_50_19       = rioja_uci_porcentaje$mujeres[6],
                     uci_mujeres_60_19       = rioja_uci_porcentaje$mujeres[7],
                     uci_mujeres_70_Mas      = rioja_uci_porcentaje$mujeres[8],
                     
                     
                     fecha_publicacion_uci_porcentaje       = as.Date(fecha_valores_uci_porcentaje[1], '%d/%m/%Y'),
                     ultima_actualizacion_uci_porcentaje    = as.Date(fecha_valores_uci_porcentaje[2], '%d/%m/%Y'),
                     ambito_temporal_uci_porcentaje         = as.Date(fecha_valores_uci_porcentaje[3], '%d/%m/%Y')
                     )
```

Guardamos

```{r}
saveRDS(rioja_uci_porcentaje, file = paste0('./data/rioja_uci_porcentaje_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```





## Porcentaje de fallecidos por grupo de edad y sexo

Porcentaje de fallecidos por grupo de edad y sexo a fecha actual

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-455](https://web.larioja.org/dato-abierto/datoabierto?n=opd-455)


```{r}
page_fallecidos_porcentaje <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-455')

# find all nodes with a class of "col_md_6"
col_md_6_fallecidos_porcentaje <- html_nodes(page_fallecidos_porcentaje, css = '.col-md-6')
col_md_6_fallecidos_porcentaje
```

```{r}
fecha_campos_fallecidos_porcentaje <- html_children(col_md_6_fallecidos_porcentaje[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_fallecidos_porcentaje
```

```{r}
fecha_valores_fallecidos_porcentaje <- html_children(col_md_6_fallecidos_porcentaje[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_fallecidos_porcentaje
```

Ahora bajamos el fichero


```{r}
link_fallecidos_porcentaje <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDU1fGNmPTAz'
```

```{r}
rioja_fallecidos_porcentaje <- read_delim(link_fallecidos_porcentaje, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_fallecidos_porcentaje <- as.data.frame(rioja_fallecidos_porcentaje)
```

```{r}
names(rioja_fallecidos_porcentaje) <- c("franja_edad", "hombres", 
                             "mujeres", "x4")
```

Borramos x4

```{r}
rioja_fallecidos_porcentaje <- rioja_fallecidos_porcentaje[, 1:3]
```

Incorporamos la fecha del dato

```{r}
rioja_fallecidos_porcentaje$fecha_publicacion_fallecidos_porcentaje    = as.Date(fecha_valores_fallecidos_porcentaje[1], '%d/%m/%Y')
rioja_fallecidos_porcentaje$ultima_actualizacion_fallecidos_porcentaje = as.Date(fecha_valores_fallecidos_porcentaje[2], '%d/%m/%Y')
rioja_fallecidos_porcentaje$ambito_temporal_fallecidos_porcentaje      = as.Date(fecha_valores_fallecidos_porcentaje[3], '%d/%m/%Y')
```

```{r}
summary(rioja_fallecidos_porcentaje)
```

```{r}
str(rioja_fallecidos_porcentaje)
```

```{r}
sum(rioja_fallecidos_porcentaje$hombres)
```

```{r}
sum(rioja_fallecidos_porcentaje$mujeres)
```


**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(
                     # fallecidos_hombres_00_09       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '0-9 '],
                     # fallecidos_hombres_10_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '10-19 '],
                     # fallecidos_hombres_20_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '20-29 '],
                     # fallecidos_hombres_30_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '30-39 '],
                     # fallecidos_hombres_40_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '40-49 '],
                     # fallecidos_hombres_50_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '50-59 '],
                     # fallecidos_hombres_60_19       = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '60-69 '],
                     # fallecidos_hombres_70_Mas      = rioja_fallecidos_porcentaje$hombres[rioja_fallecidos_porcentaje$franja_edad == '70 y más'],
                     # 
                     # fallecidos_mujeres_00_09       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '0-9 '],
                     # fallecidos_mujeres_10_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '10-19 '],
                     # fallecidos_mujeres_20_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '20-29 '],
                     # fallecidos_mujeres_30_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '30-39 '],
                     # fallecidos_mujeres_40_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '40-49 '],
                     # fallecidos_mujeres_50_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '50-59 '],
                     # fallecidos_mujeres_60_19       = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '60-69 '],
                     # fallecidos_mujeres_70_Mas      = rioja_fallecidos_porcentaje$mujeres[rioja_fallecidos_porcentaje$franja_edad == '70 y más'],
                     
                     fallecidos_hombres_00_09       = rioja_fallecidos_porcentaje$hombres[1],
                     fallecidos_hombres_10_19       = rioja_fallecidos_porcentaje$hombres[2],
                     fallecidos_hombres_20_19       = rioja_fallecidos_porcentaje$hombres[3],
                     fallecidos_hombres_30_19       = rioja_fallecidos_porcentaje$hombres[4],
                     fallecidos_hombres_40_19       = rioja_fallecidos_porcentaje$hombres[5],
                     fallecidos_hombres_50_19       = rioja_fallecidos_porcentaje$hombres[6],
                     fallecidos_hombres_60_19       = rioja_fallecidos_porcentaje$hombres[7],
                     fallecidos_hombres_70_Mas      = rioja_fallecidos_porcentaje$hombres[8],
                     
                     fallecidos_mujeres_00_09       = rioja_fallecidos_porcentaje$mujeres[1],
                     fallecidos_mujeres_10_19       = rioja_fallecidos_porcentaje$mujeres[2],
                     fallecidos_mujeres_20_19       = rioja_fallecidos_porcentaje$mujeres[3],
                     fallecidos_mujeres_30_19       = rioja_fallecidos_porcentaje$mujeres[4],
                     fallecidos_mujeres_40_19       = rioja_fallecidos_porcentaje$mujeres[5],
                     fallecidos_mujeres_50_19       = rioja_fallecidos_porcentaje$mujeres[6],
                     fallecidos_mujeres_60_19       = rioja_fallecidos_porcentaje$mujeres[7],
                     fallecidos_mujeres_70_Mas      = rioja_fallecidos_porcentaje$mujeres[8],
                     
                     
                     fecha_publicacion_fallecidos_porcentaje       = as.Date(fecha_valores_fallecidos_porcentaje[1], '%d/%m/%Y'),
                     ultima_actualizacion_fallecidos_porcentaje    = as.Date(fecha_valores_fallecidos_porcentaje[2], '%d/%m/%Y'),
                     ambito_temporal_fallecidos_porcentaje         = as.Date(fecha_valores_fallecidos_porcentaje[3], '%d/%m/%Y')
                     )
```

Guardamos

```{r}
saveRDS(rioja_fallecidos_porcentaje, file = paste0('./data/rioja_fallecidos_porcentaje_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```


## Porcentaje de casos por grupos de edad

Porcentaje de casos por grupo de edad y sexo a fecha actual

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-456](https://web.larioja.org/dato-abierto/datoabierto?n=opd-456)


```{r}
page_casos_porcentaje <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-456')

# find all nodes with a class of "col_md_6"
col_md_6_casos_porcentaje <- html_nodes(page_casos_porcentaje, css = '.col-md-6')
col_md_6_casos_porcentaje
```

```{r}
fecha_campos_casos_porcentaje <- html_children(col_md_6_casos_porcentaje[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_casos_porcentaje
```

```{r}
fecha_valores_casos_porcentaje <- html_children(col_md_6_casos_porcentaje[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_casos_porcentaje
```

Ahora bajamos el fichero


```{r}
link_casos_porcentaje <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDU2fGNmPTAz'
```

```{r}
rioja_casos_porcentaje <- read_delim(link_casos_porcentaje, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_casos_porcentaje <- as.data.frame(rioja_casos_porcentaje)
```

```{r}
names(rioja_casos_porcentaje) <- c("franja_edad", "hombres", 
                             "mujeres", "x4")
```

Borramos x4

```{r}
rioja_casos_porcentaje <- rioja_casos_porcentaje[, 1:3]
```

Incorporamos la fecha del dato

```{r}
rioja_casos_porcentaje$fecha_publicacion_casos_porcentaje    = as.Date(fecha_valores_casos_porcentaje[1], '%d/%m/%Y')
rioja_casos_porcentaje$ultima_actualizacion_casos_porcentaje = as.Date(fecha_valores_casos_porcentaje[2], '%d/%m/%Y')
rioja_casos_porcentaje$ambito_temporal_casos_porcentaje      = as.Date(fecha_valores_casos_porcentaje[3], '%d/%m/%Y')
```

```{r}
summary(rioja_casos_porcentaje)
```

```{r}
str(rioja_casos_porcentaje)
```

```{r}
sum(rioja_casos_porcentaje$hombres)
```

```{r}
sum(rioja_casos_porcentaje$mujeres)
```


**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(
                     # casos_hombres_00_09       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '0-9 '],
                     # casos_hombres_10_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '10-19 '],
                     # casos_hombres_20_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '20-29 '],
                     # casos_hombres_30_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '30-39 '],
                     # casos_hombres_40_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '40-49 '],
                     # casos_hombres_50_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '50-59 '],
                     # casos_hombres_60_19       = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '60-69 '],
                     # casos_hombres_70_Mas      = rioja_casos_porcentaje$hombres[rioja_casos_porcentaje$franja_edad == '70 y más'],
                     # 
                     # casos_mujeres_00_09       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '0-9 '],
                     # casos_mujeres_10_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '10-19 '],
                     # casos_mujeres_20_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '20-29 '],
                     # casos_mujeres_30_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '30-39 '],
                     # casos_mujeres_40_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '40-49 '],
                     # casos_mujeres_50_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '50-59 '],
                     # casos_mujeres_60_19       = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '60-69 '],
                     # casos_mujeres_70_Mas      = rioja_casos_porcentaje$mujeres[rioja_casos_porcentaje$franja_edad == '70 y más'],
                     
                     casos_hombres_00_09       = rioja_casos_porcentaje$hombres[1],
                     casos_hombres_10_19       = rioja_casos_porcentaje$hombres[2],
                     casos_hombres_20_19       = rioja_casos_porcentaje$hombres[3],
                     casos_hombres_30_19       = rioja_casos_porcentaje$hombres[4],
                     casos_hombres_40_19       = rioja_casos_porcentaje$hombres[5],
                     casos_hombres_50_19       = rioja_casos_porcentaje$hombres[6],
                     casos_hombres_60_19       = rioja_casos_porcentaje$hombres[7],
                     casos_hombres_70_Mas      = rioja_casos_porcentaje$hombres[8],
                     
                     casos_mujeres_00_09       = rioja_casos_porcentaje$mujeres[1],
                     casos_mujeres_10_19       = rioja_casos_porcentaje$mujeres[2],
                     casos_mujeres_20_19       = rioja_casos_porcentaje$mujeres[3],
                     casos_mujeres_30_19       = rioja_casos_porcentaje$mujeres[4],
                     casos_mujeres_40_19       = rioja_casos_porcentaje$mujeres[5],
                     casos_mujeres_50_19       = rioja_casos_porcentaje$mujeres[6],
                     casos_mujeres_60_19       = rioja_casos_porcentaje$mujeres[7],
                     casos_mujeres_70_Mas      = rioja_casos_porcentaje$mujeres[8],
                     
                     
                     fecha_publicacion_casos_porcentaje       = as.Date(fecha_valores_casos_porcentaje[1], '%d/%m/%Y'),
                     ultima_actualizacion_casos_porcentaje    = as.Date(fecha_valores_casos_porcentaje[2], '%d/%m/%Y'),
                     ambito_temporal_casos_porcentaje         = as.Date(fecha_valores_casos_porcentaje[3], '%d/%m/%Y')
                     )
```

Guardamos

```{r}
saveRDS(rioja_casos_porcentaje, file = paste0('./data/rioja_casos_porcentaje_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```


## Pruebas realizadas en La Rioja

Pruebas realizadas en La Rioja (PCR y pruebas rápidas de anticuerpos)

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-462](https://web.larioja.org/dato-abierto/datoabierto?n=opd-462)

```{r}
page_pruebas <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-462')

# find all nodes with a class of "col_md_6"
col_md_6_pruebas <- html_nodes(page_pruebas, css = '.col-md-6')
col_md_6_pruebas
```

```{r}
fecha_campos_pruebas <- html_children(col_md_6_pruebas[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_pruebas
```

```{r}
fecha_valores_pruebas <- html_children(col_md_6_pruebas[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_pruebas
```

Ahora bajamos el fichero


```{r}
link_pruebas <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDYyfGNmPTAz'
```

```{r}
rioja_pruebas <- read_delim(link_pruebas, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_pruebas <- as.data.frame(rioja_pruebas)
```

```{r}
names(rioja_pruebas) <- c("tipo_prueba", "total_pruebas", "pruebas_positivas", 
                          "Porcentaje_pruebas_positivas")
```

Incorporamos la fecha del dato

```{r}
rioja_pruebas$fecha_publicacion_pruebas    = as.Date(fecha_valores_pruebas[1], '%d/%m/%Y')
rioja_pruebas$ultima_actualizacion_pruebas = as.Date(fecha_valores_pruebas[2], '%d/%m/%Y')
rioja_pruebas$ambito_temporal_pruebas      = as.Date(fecha_valores_pruebas[3], '%d/%m/%Y')
```

```{r}
summary(rioja_pruebas)
```

**Revisar que cuadra**

```{r}
# En esta caso es la última línea
diario <- data.frame(
                     pcr_realizadas                  = rioja_pruebas$total_pruebas[1],
                     pcr_positivos                   = rioja_pruebas$pruebas_positivas[1],
                     pruebas_rapidas_anticuerpos     = rioja_pruebas$total_pruebas[2],
                     pruebas_rapidas_positivas       = rioja_pruebas$pruebas_positivas[2],

                     fecha_publicacion_pruebas       = as.Date(fecha_valores_pruebas[1], '%d/%m/%Y'),
                     ultima_actualizacion_pruebas    = as.Date(fecha_valores_pruebas[2], '%d/%m/%Y'),
                     ambito_temporal_pruebas         = as.Date(fecha_valores_pruebas[3], '%d/%m/%Y')
                     )
```

Guardamos

```{r}
saveRDS(rioja_pruebas, file = paste0('./data/rioja_pruebas_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```



## Salidas domiciliarias

Datos de salidas domiciliarias por día realizadas en La Rioja. Incluye fecha y número de salidas

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-463](https://web.larioja.org/dato-abierto/datoabierto?n=opd-463)

```{r}
page_salidas_domiciliarias <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-463')

# find all nodes with a class of "col_md_6"
col_md_6_salidas_domiciliarias <- html_nodes(page_salidas_domiciliarias, css = '.col-md-6')
col_md_6_salidas_domiciliarias
```

```{r}
fecha_campos_salidas_domiciliarias <- html_children(col_md_6_salidas_domiciliarias[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_salidas_domiciliarias
```

```{r}
fecha_valores_salidas_domiciliarias <- html_children(col_md_6_salidas_domiciliarias[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_salidas_domiciliarias
```

Ahora bajamos el fichero

```{r}
link_salidas_domiciliarias <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDYzfGNmPTAz'
```

```{r}
rioja_salidas_domiciliarias <- read_delim(link_salidas_domiciliarias, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_salidas_domiciliarias <- as.data.frame(rioja_salidas_domiciliarias)
```

```{r}
names(rioja_salidas_domiciliarias) <- c("fecha", "salidas_domiciliarias")
```

**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_salidas_domiciliarias$fecha = as.Date(rioja_salidas_domiciliarias$fecha, '%m/%d/%Y')
```

Calculamos los acumulados

```{r}
# Valores diarios
rioja_salidas_domiciliarias$acumulado_salidas_domiciliarias <- 0

for (i in 2:dim(rioja_salidas_domiciliarias)[1]) {
  rioja_salidas_domiciliarias$acumulado_salidas_domiciliarias[i] <- rioja_salidas_domiciliarias$acumulado_salidas_domiciliarias[i-1] + rioja_salidas_domiciliarias$salidas_domiciliarias[i]
}
```

Incorporamos la fecha del dato

```{r}
rioja_salidas_domiciliarias$fecha_publicacion_salidas_domiciliarias    = as.Date(fecha_valores_salidas_domiciliarias[1], '%d/%m/%Y')
rioja_salidas_domiciliarias$ultima_actualizacion_salidas_domiciliarias = as.Date(fecha_valores_salidas_domiciliarias[2], '%d/%m/%Y')
rioja_salidas_domiciliarias$ambito_temporal_salidas_domiciliarias      = as.Date(fecha_valores_salidas_domiciliarias[3], '%d/%m/%Y')
```

```{r}
summary(rioja_salidas_domiciliarias)
```

Guardamos

```{r}
saveRDS(rioja_salidas_domiciliarias, file = paste0('./data/rioja_salidas_domiciliarias_', Sys.Date(),'.rds'))
```



## Autoevaluaciones en el servicio online realizadas en La Rioja

Datos de autoevaluaciones en el servicio online coronavirus.riojasalud.es realizadas por día en La Rioja. Incluye fecha y número de autoevaluaciones

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-464](https://web.larioja.org/dato-abierto/datoabierto?n=opd-464)

```{r}
page_autoevaluaciones_online <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-464')

# find all nodes with a class of "col_md_6"
col_md_6_autoevaluaciones_online <- html_nodes(page_autoevaluaciones_online, css = '.col-md-6')
col_md_6_autoevaluaciones_online
```

```{r}
fecha_campos_autoevaluaciones_online <- html_children(col_md_6_autoevaluaciones_online[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_autoevaluaciones_online
```

```{r}
fecha_valores_autoevaluaciones_online <- html_children(col_md_6_autoevaluaciones_online[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_autoevaluaciones_online
```

Ahora bajamos el fichero

```{r}
link_autoevaluaciones_online <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDY0fGNmPTAz'
```

```{r}
rioja_autoevaluaciones_online <- read_delim(link_autoevaluaciones_online, ",", escape_double = FALSE, 
                               na = c("", "NA", "-"), trim_ws = TRUE)
```

```{r}
rioja_autoevaluaciones_online <- as.data.frame(rioja_autoevaluaciones_online)
```

```{r}
names(rioja_autoevaluaciones_online) <- c("fecha", "autoevaluaciones_online")
```

**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_autoevaluaciones_online$fecha = as.Date(rioja_autoevaluaciones_online$fecha, '%m/%d/%Y')
```

Calculamos los acumulados

```{r}
# Valores diarios
rioja_autoevaluaciones_online$acumulado_autoevaluaciones_online <- 0

for (i in 2:dim(rioja_autoevaluaciones_online)[1]) {
  rioja_autoevaluaciones_online$acumulado_autoevaluaciones_online[i] <- rioja_autoevaluaciones_online$acumulado_autoevaluaciones_online[i-1] + rioja_autoevaluaciones_online$autoevaluaciones_online[i]
}
```

Incorporamos la fecha del dato

```{r}
rioja_autoevaluaciones_online$fecha_publicacion_autoevaluaciones_online    = as.Date(fecha_valores_autoevaluaciones_online[1], '%d/%m/%Y')
rioja_autoevaluaciones_online$ultima_actualizacion_autoevaluaciones_online = as.Date(fecha_valores_autoevaluaciones_online[2], '%d/%m/%Y')
rioja_autoevaluaciones_online$ambito_temporal_autoevaluaciones_online      = as.Date(fecha_valores_autoevaluaciones_online[3], '%d/%m/%Y')
```

```{r}
summary(rioja_autoevaluaciones_online)
```

Guardamos

```{r}
saveRDS(rioja_autoevaluaciones_online, file = paste0('./data/rioja_autoevaluaciones_online_', Sys.Date(),'.rds'))
```


## Personal afectado del Servicio Público de Salud de La Rioja

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-457](https://web.larioja.org/dato-abierto/datoabierto?n=opd-457)


```{r}
page_casos_activos_sanitarios <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-457')

# find all nodes with a class of "col_md_6"
col_md_6_sanitarios <- html_nodes(page_casos_activos_sanitarios, css = '.col-md-6')
col_md_6_sanitarios
```

```{r}
fecha_campos_sanitarios <- html_children(col_md_6_sanitarios[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_sanitarios
```

```{r}
fecha_valores_sanitarios <- html_children(col_md_6_sanitarios[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_sanitarios
```

Ahora bajamos el fichero


```{r}
link_personal_sanitario <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDU3fGNmPTAz'
```

```{r}
rioja_personal_sanitario <- read_delim(link_personal_sanitario, ",", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
rioja_personal_sanitario <- as.data.frame(rioja_personal_sanitario)
```


```{r}
names(rioja_personal_sanitario) <- c("sanitarios_categoria_laboral", 
                                     "sanitarios_casos_activos",
                                     "sanitarios_altas", 
                                     "sanitarios_casos_acumulados")
```

```{r}
sum(rioja_personal_sanitario$casos_activos)
```

Incorporamos la fecha del dato

```{r}
rioja_personal_sanitario$fecha_publicacion_sanitarios    = as.Date(fecha_valores_sanitarios[1], '%d/%m/%Y')
rioja_personal_sanitario$ultima_actualizacion_sanitarios = as.Date(fecha_valores_sanitarios[2], '%d/%m/%Y')
rioja_personal_sanitario$ambito_temporal_sanitarios      = as.Date(fecha_valores_sanitarios[3], '%d/%m/%Y')
```

```{r}
summary(rioja_personal_sanitario)
```


**Revisar que cuadra**

```{r}
diario <- data.frame(sanitarios_casos_activos_diario    = rioja_personal_sanitario$sanitarios_casos_activos[rioja_personal_sanitario$sanitarios_categoria_laboral == 'Total'],
                     sanitarios_casos_activos_altas     = rioja_personal_sanitario$sanitarios_altas[rioja_personal_sanitario$sanitarios_categoria_laboral == 'Total'],
                     sanitarios_casos_activos_acumulado = rioja_personal_sanitario$sanitarios_casos_acumulados[rioja_personal_sanitario$sanitarios_categoria_laboral == 'Total'],
                     fecha_publicacion_sanitarios       = as.Date(fecha_valores_sanitarios[1], '%d/%m/%Y'),
                     ultima_actualizacion_sanitarios    = as.Date(fecha_valores_sanitarios[2], '%d/%m/%Y'),
                     ambito_temporal_sanitarios         = as.Date(fecha_valores_sanitarios[3], '%d/%m/%Y')
                     )
```

**Sólo pongo los totales. Los datos son semanales**

Guardamos

```{r}
saveRDS(rioja_personal_sanitario, file = paste0('./data/rioja_personal_sanitario_', Sys.Date(),'.rds'))
```

Añadimos al diario

```{r}
# resumen_diario <- data.frame(time_stamp = Sys.time())
resumen_diario <- cbind(resumen_diario, diario)
```


## Fallecimientos por días

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-458](https://web.larioja.org/dato-abierto/datoabierto?n=opd-458)

```{r}
page_casos_activos_fallecidos <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-458')

# find all nodes with a class of "col_md_6"
col_md_6_fallecidos <- html_nodes(page_casos_activos_fallecidos, css = '.col-md-6')
col_md_6_fallecidos
```

```{r}
fecha_campos_fallecidos <- html_children(col_md_6_fallecidos[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_fallecidos
```

```{r}
fecha_valores_fallecidos <- html_children(col_md_6_fallecidos[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_fallecidos
```

Ahora bajamos el fichero

```{r}
link_fallecidos <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDU4fGNmPTAz'
```

```{r}
rioja_fallecidos <- read_delim(link_fallecidos, ",", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
rioja_fallecidos <- as.data.frame(rioja_fallecidos)
```

```{r}
names(rioja_fallecidos) <- c("fecha", "fallecidos_totales", 
                             "fallecidos_residencias")
```

**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_fallecidos$fecha <- as.Date(rioja_fallecidos$fecha, '%m/%d/%y')
```

Calculamos los acumulados

```{r}
# Valores diarios
rioja_fallecidos$acumulado_fallecidos_totales     <- rioja_fallecidos$fallecidos_totales[1]
rioja_fallecidos$acumulado_fallecidos_residencias <- rioja_fallecidos$fallecidos_residencias[1]

for (i in 2:dim(rioja_fallecidos)[1]) {
  rioja_fallecidos$acumulado_fallecidos_totales[i]     <- rioja_fallecidos$acumulado_fallecidos_totales[i-1] + rioja_fallecidos$fallecidos_totales[i]
  rioja_fallecidos$acumulado_fallecidos_residencias[i] <- rioja_fallecidos$acumulado_fallecidos_residencias[i-1] + rioja_fallecidos$fallecidos_residencias[i]
}
```

Incorporamos la fecha del dato

```{r}
rioja_fallecidos$fecha_publicacion_fallecidos    = as.Date(fecha_valores_fallecidos[1], '%d/%m/%Y')
rioja_fallecidos$ultima_actualizacion_fallecidos = as.Date(fecha_valores_fallecidos[2], '%d/%m/%Y')
rioja_fallecidos$ambito_temporal_fallecidos      = as.Date(fecha_valores_fallecidos[3], '%d/%m/%Y')
```

```{r}
summary(rioja_fallecidos)
```

Guardamos

```{r}
saveRDS(rioja_fallecidos, file = paste0('./data/rioja_fallecidos_', Sys.Date(),'.rds'))
```

```{r, fig.align="center", message=FALSE, warning=FALSE}
# Change the width of bars
ggplot(data = rioja_fallecidos, aes(x = fecha, y = acumulado_fallecidos_totales)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = acumulado_fallecidos_totales), vjust = -0.3, size = 1.5)+
  theme_minimal()
```

```{r, fig.align="center", message=FALSE, warning=FALSE}
# Change the width of bars
ggplot(data = rioja_fallecidos, aes(x = fecha, y = fallecidos_totales)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = fallecidos_totales), vjust = -0.3, size = 1.5)+
  theme_minimal()
```

```{r, fig.align="center", message=FALSE, warning=FALSE}
# Change the width of bars
ggplot(data = rioja_fallecidos, aes(x = fecha, y = acumulado_fallecidos_residencias)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = acumulado_fallecidos_totales), vjust = -0.3, size = 1.5)+
  theme_minimal()
```

```{r, fig.align="center", message=FALSE, warning=FALSE}
# Change the width of bars
ggplot(data = rioja_fallecidos, aes(x = fecha, y = fallecidos_residencias)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = fallecidos_totales), vjust = -0.3, size = 1.5)+
  theme_minimal()
```



## Consultas telefónicas atendidas en La Rioja

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-465](https://web.larioja.org/dato-abierto/datoabierto?n=opd-465)

```{r}
page_llamadas <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-465')

# find all nodes with a class of "col_md_6"
col_md_6_llamadas <- html_nodes(page_llamadas, css = '.col-md-6')
col_md_6_llamadas
```

```{r}
fecha_campos_llamadas <- html_children(col_md_6_llamadas[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_llamadas
```

```{r}
fecha_valores_llamadas <- html_children(col_md_6_llamadas[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_llamadas
```

Ahora bajamos el fichero

```{r}
link_llamadas <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDY1fGNmPTAz'
```

```{r}
rioja_llamadas <- read_delim(link_llamadas, ",", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
names(rioja_llamadas) <- tolower(names(rioja_llamadas))
```

**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_llamadas$fecha <- as.Date(rioja_llamadas$fecha, '%m/%d/%y')
```

Calculamos los acumulados

```{r}
# Valores diarios
rioja_llamadas$acumulado_llamadas <- 0

for (i in 2:dim(rioja_llamadas)[1]) {
  rioja_llamadas$acumulado_llamadas[i] <- rioja_llamadas$acumulado_llamadas[i-1] + rioja_llamadas$llamadas[i]
}
```

Incorporamos la fecha del dato

```{r}
rioja_llamadas$fecha_publicacion_llamadas    = as.Date(fecha_valores_llamadas[1], '%d/%m/%Y')
rioja_llamadas$ultima_actualizacion_llamadas = as.Date(fecha_valores_llamadas[2], '%d/%m/%Y')
rioja_llamadas$ambito_temporal_llamadas      = as.Date(fecha_valores_llamadas[3], '%d/%m/%Y')
```

```{r}
summary(rioja_llamadas)
```

Guardamos

```{r}
saveRDS(rioja_llamadas, file = paste0('./data/rioja_llamadas_', Sys.Date(),'.rds'))
```



## Ritmo de reproducción (R0)

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-466](https://web.larioja.org/dato-abierto/datoabierto?n=opd-466)

```{r}
page_ritmo_reproduccion_r0 <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-466')

# find all nodes with a class of "col_md_6"
col_md_6_ritmo_reproduccion_r0 <- html_nodes(page_ritmo_reproduccion_r0 , css = '.col-md-6')
col_md_6_ritmo_reproduccion_r0
```

```{r}
fecha_campos_ritmo_reproduccion_r0 <- html_children(col_md_6_ritmo_reproduccion_r0[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_ritmo_reproduccion_r0
```

```{r}
fecha_valores_ritmo_reproduccion_r0 <- html_children(col_md_6_ritmo_reproduccion_r0[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_ritmo_reproduccion_r0
```

Ahora bajamos el fichero

```{r}
link_ritmo_reproduccion_r0 <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDY2fGNmPTAz'
```

```{r}
rioja_ritmo_reproduccion_r0 <- read_delim(link_ritmo_reproduccion_r0, ",", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
names(rioja_ritmo_reproduccion_r0) <- tolower(names(rioja_ritmo_reproduccion_r0))
```

```{r}
rioja_ritmo_reproduccion_r0 <- as.data.frame(rioja_ritmo_reproduccion_r0)
```

Borramos x3

```{r}
rioja_hospitalizados_porcentaje <- rioja_hospitalizados_porcentaje[, 1:2]
```


**Revisar esto**

Tienen que coincidir las fechas

```{r}
rioja_ritmo_reproduccion_r0$fecha <- as.Date(rioja_ritmo_reproduccion_r0$fecha, '%m/%d/%y')
```

Calculamos los acumulados

```{r, eval=FALSE}
# Valores diarios
rioja_ritmo_reproduccion_r0$acumulado_ritmo_reproduccion_r0 <- 0

for (i in 2:dim(rioja_ritmo_reproduccion_r0)[1]) {
  rioja_ritmo_reproduccion_r0$acumulado_ritmo_reproduccion_r0[i] <- rioja_ritmo_reproduccion_r0$acumulado_ritmo_reproduccion_r0[i-1] + rioja_ritmo_reproduccion_r0$ritmo_reproduccion_r0[i]
}
```

Incorporamos la fecha del dato

```{r}
rioja_ritmo_reproduccion_r0$fecha_publicacion_ritmo_reproduccion_r0    = as.Date(fecha_valores_ritmo_reproduccion_r0[1], '%d/%m/%Y')
rioja_ritmo_reproduccion_r0$ultima_actualizacion_ritmo_reproduccion_r0 = as.Date(fecha_valores_ritmo_reproduccion_r0[2], '%d/%m/%Y')
rioja_ritmo_reproduccion_r0$ambito_temporal_ritmo_reproduccion_r0      = as.Date(fecha_valores_ritmo_reproduccion_r0[3], '%d/%m/%Y')
```

```{r}
summary(rioja_ritmo_reproduccion_r0)
```

Guardamos

```{r}
saveRDS(rioja_ritmo_reproduccion_r0, file = paste0('./data/rioja_ritmo_reproduccion_r0_', Sys.Date(),'.rds'))
```


## Situación por Zonas Básicas de Salud

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-460](https://web.larioja.org/dato-abierto/datoabierto?n=opd-460)

```{r}
page_casos_activos_zonas_basicas <- read_html('https://web.larioja.org/dato-abierto/datoabierto?n=opd-460')

# find all nodes with a class of "col_md_6"
col_md_6_zonas <- html_nodes(page_casos_activos_zonas_basicas, css = '.col-md-6')
col_md_6_zonas
```

```{r}
fecha_campos_zonas <- html_children(col_md_6_zonas[8]) %>% 
    html_nodes("dt") %>% 
    html_text(trim = TRUE)
fecha_campos_zonas
```

```{r}
fecha_valores_zonas <- html_children(col_md_6_zonas[8]) %>% 
    html_nodes("dd") %>% 
    html_text(trim = TRUE)
fecha_valores_zonas
```

Ahora bajamos el fichero

```{r}
link_casos_activos_zonas_basicas <- 'https://ias1.larioja.org/opendata/download?r=Y2Q9NDYwfGNmPTAz'
```

```{r}
rioja_casos_activos_zonas_basicas <- read_delim(link_casos_activos_zonas_basicas, 
                                              ";", escape_double = FALSE, trim_ws = TRUE)
```

```{r}
names(rioja_casos_activos_zonas_basicas) <- c("latitud", "longitud", "localidad",
                                              "nombre_zbs", "casos_activos")
```

Incorporamos la fecha del dato

```{r}
rioja_casos_activos_zonas_basicas$fecha_publicacion_zonas    = as.Date(fecha_valores_zonas[1], '%d/%m/%Y')
rioja_casos_activos_zonas_basicas$ultima_actualizacion_zonas = as.Date(fecha_valores_zonas[2], '%d/%m/%Y')
rioja_casos_activos_zonas_basicas$ambito_temporal_zonas      = as.Date(fecha_valores_zonas[3], '%d/%m/%Y')
```

```{r}
sum(rioja_casos_activos_zonas_basicas$casos_activos)
```

**Revisar que cuadra**

Pasamos a incorporar los datos diarios

```{r}
diario <- data.frame(casos_activos_aberite      = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Alberite'],
                     casos_activos_alfaro       = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Alfaro'],
                     casos_activos_arnedo       = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Arnedo'],
                     casos_activos_calahorra    = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Calahorra'],
                     casos_activos_cervera      = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Cervera del Río Alhama'],
                     casos_activos_haro         = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Haro'],
                     casos_activos_logrono      = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Logroño'],
                     casos_activos_murillo      = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Murillo del Río Leza'],
                     casos_activos_najera       = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Nájera'],
                     casos_activos_navarrete    = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Navarrete'],
                     casos_activos_san_roman    = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'San Román de Cameros'],
                     casos_activos_s_domingo    = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Santo Domingo de la Calzada'],
                     casos_activos_torrecilla   = rioja_casos_activos_zonas_basicas$casos_activos[rioja_casos_activos_zonas_basicas$localidad == 'Torrecilla en Cameros'],
                     fecha_publicacion_zonas    = as.Date(fecha_valores_zonas[1], '%d/%m/%Y'),
                     ultima_actualizacion_zonas = as.Date(fecha_valores_zonas[2], '%d/%m/%Y'),
                     ambito_temporal_zonas      = as.Date(fecha_valores_zonas[3], '%d/%m/%Y')
                     )
```

```{r}
resumen_diario <- cbind(resumen_diario, diario)
```

Guardamos

```{r}
saveRDS(rioja_casos_activos_zonas_basicas, file = paste0('./data/rioja_casos_activos_zonas_basicas_', Sys.Date(),'.rds'))
```

Hacemos un mapa

Le asigno un CRS "a capón", el de OSM

```{r}
rioja_casos_activos_zonas_basicas_shp <-  sf::st_as_sf(as.data.frame(rioja_casos_activos_zonas_basicas), 
                                                       coords = c('longitud', 'latitud'), 
                                                       crs = 4326)
```


```{r mapa_casos_activos_zonas_basicas 1, fig.align="center", message=FALSE, warning=FALSE}
# tmap object
mapa_casos_activos_zonas_basicas <- tm_shape(rioja_casos_activos_zonas_basicas_shp) +
    tm_dots("casos_activos")

# dynamic map
tmap_leaflet(mapa_casos_activos_zonas_basicas)
```

```{r}
# cat(getwd())

rioja_zonas_basicas_shp <- sf::read_sf('./data/maps/ZBS_4258_LARIOJA_ESPAÑA_2017_v1.0.0/laRioja4258.shp',
                                      stringsAsFactors = TRUE)
```

Para poder hacer merge, creamos la variable *localidad*

```{r}
rioja_zonas_basicas_shp$localidad <- rioja_zonas_basicas_shp$n_zbs
levels(rioja_zonas_basicas_shp$localidad) <- c("Alberite", "Alfaro", "Arnedo",
                                               "Calahorra", "Torrecilla en Cameros",
                                               "San Román de Cameros", 
                                               "Cervera del Río Alhama",  "Haro",
                                               "Logroño", "Murillo del Río Leza",
                                               "Nájera", "Navarrete" ,
                                               "Santo Domingo de la Calzada")
```

```{r}
summary(rioja_zonas_basicas_shp)
```

```{r, , fig.align="center", message=FALSE, warning=FALSE}
plot(rioja_zonas_basicas_shp)
```

```{r mapa_casos_activos_zonas_basicas 2, fig.align="center", message=FALSE, warning=FALSE}
# Este mapa no parece bien...

# tmap object
mapa_casos_activos_zonas_basicas2 <- 
    
    tm_shape(rioja_zonas_basicas_shp) +
    tm_polygons(id          = "localidad", 
                # col         = "numberOfFloorsAboveGround", 
                border.col  = "blue",
                # palette     = col.spec.fun(15),
                alpha       = 0.5, 
                legend.show = FALSE,
                textNA      = "Sin datos",
                title       = "Localidad") +
  
    # tm_shape(rioja_casos_activos_zonas_basicas_shp) +
    # tm_dots("casos_activos")

    tm_shape(rioja_casos_activos_zonas_basicas_shp) +
    tm_dots(# id   = "localidad",
            title = "casos activos",
            size  = "casos_activos", 
            id    = "casos_activos"
            )
  

# dynamic map
tmap_leaflet(mapa_casos_activos_zonas_basicas2)
```


## Resumen diario

Guardamos el resumen diario

```{r}
saveRDS(resumen_diario, file = paste0('./data/resumen_diario_', Sys.Date(),'.rds'))
```





# Pendientes


## Datos globales

Datos globales de la pandemia de coronavirus: tasa de letalidad; tasa de hospitalización (casos activos y casos acumulados); y porcentaje de altas acumuladas 

La página de datos abiertos es esta: [https://web.larioja.org/dato-abierto/datoabierto?n=opd-459](https://web.larioja.org/dato-abierto/datoabierto?n=opd-459)












# Datos de ISCIII


## Serie historica

Los datos de (ISCIII)[https://covid19.isciii.es/]

```{r}
link_isciii <- 'https://covid19.isciii.es/resources/serie_historica_acumulados.csv'
```

En los datos en local se han eliminado las últimas filas que corresponden a comentarios.

```{r, eval=FALSE}
# Datos en local
serie_historica_acumulados_isciii <- read_csv("data/serie_historica_acumulados.csv", 
                                              locale = locale(date_names = "es"))
```

```{r}
# Directamente de Internet
serie_historica_acumulados_isciii <- read_csv(link_isciii, 
                                              locale = locale(date_names = "es"))
```

El csv incluye comentarios al final, vamos a quitarlos

```{r}
# Donde aparece por primera vez 'NOTA'
ultima_linea <- min((1:dim(serie_historica_acumulados_isciii)[1])[str_detect(serie_historica_acumulados_isciii$CCAA, 'NOTA')])
ultima_linea
```

```{r}
serie_historica_acumulados_isciii <- serie_historica_acumulados_isciii[(1:(ultima_linea-1)), ]
```

Vemos los datos por CC.AA.

```{r}
table(serie_historica_acumulados_isciii$CCAA, useNA = 'ifany')
```

Comunidades autónomas

```{r}
serie_historica_acumulados_isciii$CCAA <- factor(serie_historica_acumulados_isciii$CCAA, 
                                                 levels = c('AN', 'AR', 'AS', 'CB', 'CE', 
                                                            'CL', 'CM', 'CN', 'CT', 'EX', 
                                                            'GA', 'IB', 'MC', 'MD', 'ML', 
                                                            'NC', 'PV', 'RI', 'VC'),
                                                 labels = c('Andalucía', 'Aragón', 
                                                            'Asturias, Principado de', 
                                                            'Cantabria', 'Ceuta', 
                                                            'Castilla y León', 
                                                            'Castilla - La Mancha', 
                                                            'Canarias', 'Cantabria', 
                                                            'Extremadura', 
                                                            'Galicia', 'Balears, Illes', 
                                                            'Murcia, Región de', 
                                                            'Madrid, Comunidad de', 
                                                            'Melilla', 
                                                            'Navarra, Comunidad Foral de', 
                                                            'País Vasco', 'Rioja, La', 
                                                            'Comunitat Valenciana'))
```


Pasamos la fecha a formato *Date*

```{r}
serie_historica_acumulados_isciii$FECHA <- as.Date(serie_historica_acumulados_isciii$FECHA, "%d/%m/%Y")
```

### Nuevas columnas

```{r}
# Valores diarios
serie_historica_acumulados_isciii <- serie_historica_acumulados_isciii %>% 
  group_by(CCAA) %>% 
  arrange(FECHA) %>% 
  mutate(diario_hospitalizados = Hospitalizados - lag(Hospitalizados, order_by = FECHA),
         diario_uci            = UCI - lag(UCI, order_by = FECHA),
         diario_fallecidos     = Fallecidos - lag(Fallecidos, order_by = FECHA)
         # diario_recuperados    = Recuperados - lag(Recuperados) # Este es acumulado
  )
```

**Cantabria está duplicado**

**Revisar**

```{r}
summary(serie_historica_acumulados_isciii)
```

Guardamos

```{r}
saveRDS(serie_historica_acumulados_isciii, file = paste0('./data/serie_historica_acumulados_isciii_', Sys.Date(),'.rds'))
```



## MoMo ISCIII

Los modelos [MoMo del ISCIII](https://momo.isciii.es/public/momo/dashboard/momo_dashboard.html#nacional).

Los datos están disponibles [aquí](https://momo.isciii.es/public/momo/data) en formato CSV, y se actualizan diariamente. Son las series temporales con los resultados de MoMo para ámbito nacional y de comunidades autónomas, en diferentes grupos poblacionales, durante los últimos dos años. Consta de las siguientes columnas:

    ambito: nacional o ccaa
    cod_ambito: si es nacional, viene vacío. Si es una comunidad autónoma, trae su código ISO 3166-2.
    cod_ine_ambito: columna informativa sobre la comunidad autónoma, si aplica. Es su código INE.
    nombre_ambito: columna informativa sobre la comunidad autónoma, si aplica. Es su nombre.
    cod_sexo: código INE del sexo. 1 para hombres, 6 para mujeres.
    nombre_sexo: columna informativa sobre el sexo. Su nombre descriptivo (hombres, mujeres).
    cod_gedad: código del grupo de edad. Los posibles son: menos_65, 65_74, mas_74.
    nombre_gedad: columna informativa sobre el grupo de edad. Su nombre descriptivo (p.e. edad < 65).
    fecha_defuncion: la fecha a la que se refieren los indicadores descritos de aquí en adelante. Es la fecha en la que ocurre la defunción.
    defunciones_observadas: el número de defunciones observadas (incluye la corrección por retraso).
    defunciones_observadas_lim_inf: el límite inferior del invervalo de confianza de las defunciones observadas (debido a la corrección).
    defunciones_observadas_lim_sup: de forma equivalente, el límite superior.
    defunciones_esperadas: el número de defunciones esperadas, resultantes del modelo.
    defunciones_esperadas_q01: el límite inferior del intervalo de confianza de las defunciones esperadas, correspondiente al percentil 1 de la distribución.
    defunciones_esperadas_q99: de forma equivalente, el límite superior, al percentil 99.

Las series vienen agregadas por ámbito, código de ámbito, sexo, grupo de edad y fecha de defunción. Nótese que las series que son agregados del resto vienen en otra serie aparte. P.e., si se quiere elegir la serie de toda la población (nacional, todos los sexos, todas las edades), hay que filtrar por ambito="nacional", cod_sexo="all" y cod_gedad="all".

Los datos aquí descargados se refieren a las defunciones por todas las causas notificadas por los registros civiles informatizados de los municipios correspondientes. Para saber más, consulta las pestañas de “Documentación” y “Notificación”.

Nota: los datos cambian de forma retroactiva, especialmente en los días más recientes. Lo que hoy puedes descargar (o consultar en este portal) mañana puede tener indicadores diferentes en fechas pasadas. El motivo es el retraso en la notificación, detallado en la sección de [Documentación](https://momo.isciii.es/public/momo/dashboard/momo_dashboard.html#documentacion).


```{r}
link_momo <- 'https://momo.isciii.es/public/momo/data'
```

```{r, eval=FALSE}
# Los datos en local
data <- read_csv("data/data.csv", col_types = cols(cod_ambito = col_character(), 
    cod_ine_ambito = col_character(), nombre_ambito = col_character()), 
    locale = locale(date_names = "es", encoding = "ISO-8859-1"))
```

```{r, eval=FALSE}
summary(data)
```

```{r}
# Directamente de Internet
# momo_isciii <- read_csv(link_momo, locale = locale(date_names = "es"))
# momo_isciii <- read_delim(link_momo, ",", escape_double = FALSE, 
#                           # col_names = FALSE, 
#                           locale = locale(date_names = "es", 
#                                           decimal_mark = ",",      
#                                           grouping_mark = "."),
#                           trim_ws = TRUE)
momo_isciii <- read_csv(link_momo, col_types = cols(cod_ambito = col_character(), 
    cod_ine_ambito = col_character(), nombre_ambito = col_character()), 
    locale = locale(date_names = "es", encoding = "UTF-8"))
```


### ETL

Pasamos algunos valores a factor

```{r}
momo_isciii$ambito          <- as.factor(momo_isciii$ambito)
momo_isciii$cod_ambito      <- as.factor(momo_isciii$cod_ambito)
momo_isciii$cod_ine_ambito  <- as.factor(momo_isciii$cod_ine_ambito)
momo_isciii$nombre_ambito   <- as.factor(momo_isciii$nombre_ambito)
momo_isciii$cod_sexo        <- as.factor(momo_isciii$cod_sexo)
momo_isciii$nombre_sexo     <- as.factor(momo_isciii$nombre_sexo)
momo_isciii$cod_gedad       <- as.factor(momo_isciii$cod_gedad)
momo_isciii$nombre_gedad    <- as.factor(momo_isciii$nombre_gedad)
```

```{r}
summary(momo_isciii)
```

Esto lo necesitamos para "traducir" los códigos

```{r}
table(momo_isciii$cod_ambito, momo_isciii$nombre_ambito)
```

Guardamos

```{r}
saveRDS(momo_isciii, file = paste0('./data/momo_isciii_', Sys.Date(),'.rds'))
```


### Gráficos MoMo

```{r, eval=FALSE}
p <- ggplot(momo_isciii, aes(x = log(price), color = clarity)) + 
    geom_freqpoly()
ggplotly(p)
```



```{r}
# Un dataset intermedio
momo_temp <- momo_isciii %>% 
    dplyr::filter(ambito == 'nacional', cod_sexo == 'all', cod_gedad == 'all')


figura2 <- plot_ly(momo_temp, 
                   x = ~fecha_defuncion, y = ~defunciones_esperadas_q99, 
                   type = 'scatter', mode = 'lines',
                   line = list(color = 'transparent'),
                   showlegend = FALSE, name = 'Esperadas límite superior') 
figura2 <- figura2 %>% add_trace(y = ~defunciones_esperadas_q01, 
                                 type = 'scatter', mode = 'lines',                         
                                 fill = 'tonexty', fillcolor = 'rgba(0, 100, 80, 0.2)', 
                                 line = list(color = 'transparent'),                         
                                 showlegend = FALSE, name = 'Esperadas límite inferior') 
figura2 <- figura2 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_esperadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='rgb(0, 100, 80)'),                         
                                 name = 'Defunciones Esperadas') 
figura2 <- figura2 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_observadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='black'),                         
                                 name = 'Defunciones Observadas') 
figura2
```


Defunciones observadas (negro) y defunciones estimadas (verde), con el intervalo de confianza al 99% (banda verde). España.

Mortalidad por todas las causas. Comunidades Autónomas

y = ~get(input$Measure)



```{r}
# Un dataset intermedio
momo_temp <- momo_isciii %>% 
    dplyr::filter(ambito == 'nacional', cod_sexo == 'all', cod_gedad == 'all', 
                  fecha_defuncion > '2019-12-31')


figura3 <- plot_ly(momo_temp, 
                   x = ~fecha_defuncion, y = ~defunciones_esperadas_q99, 
                   type = 'scatter', mode = 'lines',
                   line = list(color = 'transparent'),
                   showlegend = FALSE, name = 'Esperadas límite superior') 
figura3 <- figura3 %>% add_trace(y = ~defunciones_esperadas_q01, 
                                 type = 'scatter', mode = 'lines',                         
                                 fill = 'tonexty', fillcolor = 'rgba(0, 100, 80, 0.2)', 
                                 line = list(color = 'transparent'),                         
                                 showlegend = FALSE, name = 'Esperadas límite inferior') 
figura3 <- figura3 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_esperadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='rgb(0, 100, 80)'),                         
                                 name = 'Defunciones Esperadas') 
figura3 <- figura3 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_observadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='black'),                         
                                 name = 'Defunciones Observadas') 
figura3 <- figura3 %>% layout(title = "Mortalidad por todas las causas. España")
figura3
```



```{r}
# Un dataset intermedio
momo_temp <- momo_isciii %>% 
    dplyr::filter(ambito == 'nacional', cod_sexo == 'all', cod_gedad == 'all', 
                  fecha_defuncion > '2019-12-31')


figura4 <- plot_ly(momo_temp, 
                   x = ~fecha_defuncion, y = ~defunciones_esperadas_q99, 
                   type = 'scatter', mode = 'lines',
                   line = list(color = 'transparent'),
                   showlegend = FALSE, name = 'Esperadas límite superior') 
figura4 <- figura4 %>% add_trace(y = ~defunciones_esperadas_q01, 
                                 type = 'scatter', mode = 'lines',                         
                                 fill = 'tonexty', fillcolor = 'rgba(0, 100, 80, 0.2)', 
                                 line = list(color = 'transparent'),                         
                                 showlegend = FALSE, name = 'Esperadas límite inferior') 
figura4 <- figura4 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_esperadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='rgb(0, 100, 80)'),                         
                                 name = 'Defunciones Esperadas') 
figura4 <- figura4 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_observadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='black'),                         
                                 name = 'Defunciones Observadas') 
figura4 <- figura4 %>% layout(title = "Mortalidad por todas las causas. España")

figura4
```

```{r}
# Un dataset intermedio
momo_temp <- momo_isciii %>% 
    dplyr::filter(nombre_ambito == 'Rioja, La', cod_sexo == 'all', cod_gedad == 'all', 
                  fecha_defuncion > '2019-12-31')


figura5 <- plot_ly(momo_temp, 
                   x = ~fecha_defuncion, y = ~defunciones_esperadas_q99, 
                   type = 'scatter', mode = 'lines',
                   line = list(color = 'transparent'),
                   showlegend = FALSE, name = 'Esperadas límite superior') 
figura5 <- figura5 %>% add_trace(y = ~defunciones_esperadas_q01, 
                                 type = 'scatter', mode = 'lines',                         
                                 fill = 'tonexty', fillcolor = 'rgba(0, 100, 80, 0.2)', 
                                 line = list(color = 'transparent'),                         
                                 showlegend = FALSE, name = 'Esperadas límite inferior') 
figura5 <- figura5 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_esperadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='rgb(0, 100, 80)'),                         
                                 name = 'Defunciones Esperadas') 
figura5 <- figura5 %>% add_trace(x = ~fecha_defuncion, y = ~defunciones_observadas, 
                                 type = 'scatter', mode = 'lines',                         
                                 line = list(color='black'),                         
                                 name = 'Defunciones Observadas') 
figura5 <- figura5 %>% layout(title = "Mortalidad por todas las causas. La Rioja")

figura5
```





# Analisis 

```{r}
madrid <- serie_historica_acumulados_isciii[serie_historica_acumulados_isciii$CCAA == 'Madrid, Comunidad de', ]
```

```{r}
rioja <- serie_historica_acumulados_isciii[serie_historica_acumulados_isciii$CCAA == 'Rioja, La', ]
```

```{r}
summary(rioja)
```

```{r}
start_point_daily <-  c(1, 1)
start_point_daily 
## [1] 1 1
```

```{r}
rioja_ts_uci_daily <- 
  rioja %>%  
  select(UCI) %>%
  ts(start = start_point_daily, frequency = 365)
```

```{r}
ts_info(rioja_ts_uci_daily)
```

```{r, eval=FALSE}
# Tiene que haber al menos dos años
ts_decompose(rioja_ts_uci_daily, type = 'additive')
```

```{r, eval=FALSE}
ts_acf(rioja_ts_uci_daily, lag.max = 365)
```

```{r}
summary(rioja_ts_uci_daily)
```



```{r}
rioja_ts <- ts(rioja, frequency = 365, start = as.Date('2020-02-20'))
```

```{r}
summary(rioja_ts)
```





Terminamos con la información de la sesión

```{r}
sessionInfo()
```

## Datos

* [Situación de COVID-19 en España](https://covid19.isciii.es/)
* [ES: Mapa georreferenciado de las zonas básicas de salud de LA RIOJA. Año 2017. España. || EN: Georeferenced map of primary care area of reference in LA RIOJA. Year 2017. Spain.](https://zenodo.org/record/1320339#.XrMCk_lS_RI)

## Referencias

* []()


## Licencias
